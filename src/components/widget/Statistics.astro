---
import { getCollection } from "astro:content";
import dayjs from "dayjs";
import duration from "dayjs/plugin/duration";
import WidgetLayout from "./WidgetLayout.astro";

dayjs.extend(duration);

// --- 数据计算部分 ---
const posts = await getCollection("posts", ({ data }) => {
	return data.draft !== true;
});

const totalPosts = posts.length;

// 定义一个健壮的字数统计函数
function calculateWordCount(text: string): number {
	if (!text) {
		return 0;
	}

	// 【关键修正：修复了正则表达式的语法错误】
	// 之前的 /[#*`->[\]_~|]/g 是错误的。
	// 正确的写法应该将特殊字符 '-' 进行转义，写作 '\-'。
	const plainText = text
		.replace(/```[\s\S]*?```/g, "") // 移除代码块
		.replace(/<[^>]*>/g, "") // 移除 HTML 标签
		.replace(/[#*`>[\]_~|-]/g, ""); // 移除 Markdown 符号

	// 分别计算中文字符和英文单词
	const chineseChars = plainText.match(/[\u4e00-\u9fa5]/g) || [];
	const englishWords = plainText.match(/\b[a-zA-Z0-9]+\b/g) || [];

	// 返回总和
	return chineseChars.length + englishWords.length;
}

// 使用我们自己的函数来累加总字数
const totalWords = posts.reduce(
	(sum, post) => sum + calculateWordCount(post.body),
	0,
);

const formattedTotalWords = (num: number) => {
	if (num < 1000) return num.toString();
	return `${(num / 1000).toFixed(1)}k`;
};

// ... 以下其他计算逻辑保持完全不变 ...
let runningTime = { years: 0, months: 0, days: 0 };
if (posts.length > 0) {
	const sortedPostsAsc = [...posts].sort(
		(a, b) =>
			new Date(a.data.published).getTime() -
			new Date(b.data.published).getTime(),
	);
	const firstPostDate = dayjs(sortedPostsAsc[0].data.published);
	const today = dayjs();
	const diff = dayjs.duration(today.diff(firstPostDate));
	runningTime = {
		years: diff.years(),
		months: diff.months(),
		days: diff.days(),
	};
}

let lastUpdated = "N/A";
if (posts.length > 0) {
	const sortedPostsDesc = [...posts].sort(
		(a, b) =>
			new Date(b.data.published).getTime() -
			new Date(a.data.published).getTime(),
	);
	lastUpdated = dayjs(sortedPostsDesc[0].data.published).format("YYYY-MM-DD");
}
---

<WidgetLayout name="站点信息" id="statistics">
    <div class="grid grid-cols-2 gap-x-4 gap-y-5 text-center">
        <div>
            <div class="text-sm text-gray-500 dark:text-gray-400">文章总数</div>
            <div class="text-xl font-bold">{totalPosts} <span class="text-xs">篇</span></div>
        </div>
        
        <div>
            <div class="text-sm text-gray-500 dark:text-gray-400">总字数</div>
            <div class="text-xl font-bold">{formattedTotalWords(totalWords)}</div>
        </div>

        <div>
            <div class="text-sm text-gray-500 dark:text-gray-400">运营时间</div>
            <div class="text-xl font-bold">
                {runningTime.years > 0 && `${runningTime.years} 年 `}
                {runningTime.months > 0 && `${runningTime.months} 月 `}
                {runningTime.days} <span class="text-xs">天</span>
            </div>
        </div>

        <div>
            <div class="text-sm text-gray-500 dark:text-gray-400">最后更新</div>
            <div class="text-xl font-bold">{lastUpdated}</div>
        </div>
    </div>
</WidgetLayout>