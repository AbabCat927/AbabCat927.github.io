---
// æ–‡ä»¶è·¯å¾„: src/components/widget/VisitCounter.astro
// åŠŸèƒ½: è¿™æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºä» Umami API è·å–å¹¶æ˜¾ç¤ºç½‘ç«™è®¿é—®é‡çš„ç»„ä»¶ã€‚
// ç‰ˆæœ¬: v3.0 - ä¿®æ­£äº†æ•°æ®æºï¼Œç°åœ¨ä»æ­£ç¡®çš„ umamiConfig ç»“æ„ä¸­è¯»å–æ•°æ®ï¼Œå¹¶å¢åŠ äº†å¥å£®æ€§æ£€æŸ¥ã€‚

import { umamiConfig } from "../../config";

// --- æ­¥éª¤ 1: ä»æ‚¨çš„ã€æ–°ã€‘é…ç½®ä¸­å®‰å…¨åœ°è§£æå‡ºæ‰€æœ‰éœ€è¦çš„ä¿¡æ¯ ---

// ã€ä¿®æ­£ã€‘ç›´æ¥ä» umamiConfig ä¸­è·å– websiteIdï¼Œä¸å†ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ã€‚
const websiteId = umamiConfig.websiteId;

// ã€ä¿®æ­£ã€‘ä¸ºäº†è·å– shareId å’Œ regionï¼Œæˆ‘ä»¬éœ€è¦åœ¨ config.ts ä¸­æ·»åŠ ä¸€ä¸ªæ–°å­—æ®µã€‚
// è¿™é‡Œæˆ‘ä»¬å…ˆå®‰å…¨åœ°è§£æå®ƒï¼Œå¦‚æœä¸å­˜åœ¨ä¹Ÿä¸ä¼šå´©æºƒã€‚
const fullShareUrl = umamiConfig.shareUrl; // å‡è®¾æ–°å­—æ®µå« shareUrl
const shareUrlParts =
	typeof fullShareUrl === "string"
		? fullShareUrl.match(
				/https:\/\/([a-z]{2})\.umami\.is\/share\/([a-zA-Z0-9]+)/,
			)
		: null;

const region = shareUrlParts?.[1];
const shareId = shareUrlParts?.[2];

// --- æ­¥éª¤ 2: å®šä¹‰ä¸€ä¸ªå¼‚æ­¥å‡½æ•°æ¥è·å–è®¿é—®é‡æ•°æ® ---

async function getVisitCount() {
	// ã€ä¿®æ­£ã€‘æ›´æ–°äº†æ£€æŸ¥æ¡ä»¶ï¼Œç¡®ä¿æ‰€æœ‰å¿…éœ€ä¿¡æ¯éƒ½å­˜åœ¨ã€‚
	if (!websiteId || !region || !shareId) {
		console.error(
			"Umami VisitCounter é”™è¯¯ï¼šæ— æ³•è·å– websiteId, region, æˆ– shareIdã€‚è¯·ç¡®ä¿åœ¨ config.ts ä¸­æ­£ç¡®é…ç½®äº† websiteId å’Œ shareUrlã€‚",
		);
		// è¿”å› 'N/A' è€Œä¸æ˜¯ 0ï¼Œè®©å‰ç«¯æ˜ç¡®æ˜¾ç¤ºé”™è¯¯çŠ¶æ€ã€‚
		return "N/A";
	}

	try {
		// ç¬¬ä¸€æ­¥: è·å–ä¸´æ—¶çš„è®¿é—®ä»¤ç‰Œ (token)
		const tokenResponse = await fetch(
			`https://${region}.umami.is/api/share/${shareId}`,
		);

		if (!tokenResponse.ok) {
			throw new Error(`è·å– Umami Token å¤±è´¥ï¼ŒçŠ¶æ€ç : ${tokenResponse.status}`);
		}
		const { token } = await tokenResponse.json();
		if (!token) {
			throw new Error("Umami API è¿”å›çš„æ•°æ®ä¸­ä¸åŒ…å« Tokenã€‚");
		}

		// ç¬¬äºŒæ­¥: ä½¿ç”¨è·å–åˆ°çš„ token å»è¯·æ±‚çœŸå®çš„ç»Ÿè®¡æ•°æ®
		const statsResponse = await fetch(
			`https://${region}.umami.is/api/websites/${websiteId}/stats`,
			{
				method: "GET",
				headers: {
					Authorization: `Bearer ${token}`,
				},
			},
		);

		if (!statsResponse.ok) {
			throw new Error(
				`è·å– Umami ç»Ÿè®¡æ•°æ®å¤±è´¥ï¼ŒçŠ¶æ€ç : ${statsResponse.status}`,
			);
		}
		const data = await statsResponse.json();

		// è¿”å›ç»Ÿè®¡åˆ°çš„ pageviews å€¼
		return data?.pageviews?.value || 0;
	} catch (error) {
		console.error("è·å– Umami è®¿é—®é‡æ•°æ®æ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯:", error);
		return "N/A"; // å‡ºé”™æ—¶ä¹Ÿè¿”å› 'N/A'
	}
}

const visitCount = await getVisitCount();
---

<!-- HTML å’Œ Style éƒ¨åˆ†ä¿æŒä¸å˜ -->
<div class="visit-counter-widget">
    <span class="icon">ğŸ‘ï¸</span>
    <span class="label">æ€»è®¿é—®é‡:</span>
    <span class="count">{visitCount}</span>
</div>

<style>
/* æ ·å¼ä¿æŒä¸å˜ */
.visit-counter-widget {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  background-color: var(--card-bg);
  border-radius: 0.5rem;
  font-size: 0.9em;
  color: var(--text-color);
  border: 1px solid var(--card-border-color);
}
.icon {
  font-size: 1.2em;
}
.label {
  color: var(--text-color-light);
}
.count {
  font-weight: 600;
  color: var(--primary-color);
}
</style>