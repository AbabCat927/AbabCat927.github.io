---
// æ–‡ä»¶è·¯å¾„: src/components/widget/VisitCounter.astro
// åŠŸèƒ½: è¿™æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºä» Umami API è·å–å¹¶æ˜¾ç¤ºç½‘ç«™è®¿é—®é‡çš„ç»„ä»¶ã€‚
// ç‰ˆæœ¬: v2.1 - ä¿®æ­£äº†ä»£ç é£æ ¼é—®é¢˜ï¼Œéµå¾ª Biome linter å»ºè®®ã€‚

import { umamiConfig } from "../../config";

// --- æ­¥éª¤ 1: ä»æ‚¨çš„é…ç½®ä¸­è§£æå‡ºæ‰€æœ‰éœ€è¦çš„ä¿¡æ¯ ---

const fullShareUrl = umamiConfig.baseUrl;
const websiteId = umamiConfig.scripts.match(/data-website-id="([^"]+)"/)?.[1];
const shareUrlParts = fullShareUrl.match(
	/https:\/\/([a-z]{2})\.umami\.is\/share\/([a-zA-Z0-9]+)/,
);
const region = shareUrlParts?.[1];
const shareId = shareUrlParts?.[2];

// --- æ­¥éª¤ 2: å®šä¹‰ä¸€ä¸ªå¼‚æ­¥å‡½æ•°æ¥è·å–è®¿é—®é‡æ•°æ® ---

async function getVisitCount() {
	if (!websiteId || !region || !shareId) {
		console.error(
			"Umami é…ç½®è§£æå¤±è´¥ï¼šæ— æ³•ä» config.ts ä¸­æå– websiteId, region, æˆ– shareIdã€‚è¯·æ£€æŸ¥ baseUrl å’Œ scripts é…ç½®æ˜¯å¦æ­£ç¡®ã€‚",
		);
		return 0;
	}

	try {
		// ç¬¬ä¸€æ­¥: è·å–ä¸´æ—¶çš„è®¿é—®ä»¤ç‰Œ (token)
		// ã€ä»£ç é£æ ¼ä¿®æ­£ã€‘ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²æ›¿ä»£å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œè®©ä»£ç æ›´æ¸…æ™°ã€‚
		const tokenResponse = await fetch(
			`https://${region}.umami.is/api/share/${shareId}`,
		);

		if (!tokenResponse.ok) {
			throw new Error(`è·å– Umami Token å¤±è´¥ï¼ŒçŠ¶æ€ç : ${tokenResponse.status}`);
		}
		const { token } = await tokenResponse.json();
		if (!token) {
			throw new Error("Umami API è¿”å›çš„æ•°æ®ä¸­ä¸åŒ…å« Tokenã€‚");
		}

		// ç¬¬äºŒæ­¥: ä½¿ç”¨è·å–åˆ°çš„ token å»è¯·æ±‚çœŸå®çš„ç»Ÿè®¡æ•°æ®
		// ã€ä»£ç é£æ ¼ä¿®æ­£ã€‘åŒæ ·ï¼Œè¿™é‡Œä¹Ÿä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²æ¥æ„å»º URLã€‚
		const statsResponse = await fetch(
			`https://${region}.umami.is/api/websites/${websiteId}/stats`,
			{
				method: "GET",
				headers: {
					Authorization: `Bearer ${token}`,
				},
			},
		);

		if (!statsResponse.ok) {
			throw new Error(
				`è·å– Umami ç»Ÿè®¡æ•°æ®å¤±è´¥ï¼ŒçŠ¶æ€ç : ${statsResponse.status}`,
			);
		}
		const data = await statsResponse.json();

		return data?.pageviews?.value || 0;
	} catch (error) {
		console.error("è·å– Umami è®¿é—®é‡æ•°æ®æ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯:", error);
		return 0;
	}
}

const visitCount = await getVisitCount();
---

<!-- HTML å’Œ Style éƒ¨åˆ†ä¿æŒä¸å˜ -->
<div class="visit-counter-widget">
    <span class="icon">ğŸ‘ï¸</span>
    <span class="label">æ€»è®¿é—®é‡:</span>
    <span class="count">{visitCount > 0 ? visitCount : "ä¸å¯ç”¨"}</span>
</div>

<style>
.visit-counter-widget {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  background-color: var(--card-bg);
  border-radius: 0.5rem;
  font-size: 0.9em;
  color: var(--text-color);
  border: 1px solid var(--card-border-color);
}
.icon {
  font-size: 1.2em;
}
.label {
  color: var(--text-color-light);
}
.count {
  font-weight: 600;
  color: var(--primary-color);
}
</style>

