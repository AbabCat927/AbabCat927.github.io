# Dockerfile (最终修正版)

# ---------------------------------
# 阶段 1: 基础镜像 (保持不变)
# ---------------------------------
# 使用基于 Debian 的 `node:20-slim` 镜像，以确保兼容性。
FROM node:20-slim

# ---------------------------------
# 阶段 2: 【关键修正】更换系统软件源为国内镜像
# ---------------------------------
# 运行 `sed` 命令来编辑系统的软件源配置文件。
# 目标文件已从旧的 `/etc/apt/sources.list` 修正为新版系统中的 `/etc/apt/sources.list.d/debian.sources`。
# 这条指令会将所有官方的 `deb.debian.org` 地址，替换为速度更快的阿里云镜像地址 `mirrors.aliyun.com`。
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources

# ---------------------------------
# 阶段 3: 安装系统级依赖
# ---------------------------------
# 更新软件包列表，并安装 Git。
# 安装完成后清理 apt 缓存，以减小最终镜像的体积。
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*

# ---------------------------------
# 阶段 4: 安装项目级工具 (保持不变)
# ---------------------------------
RUN npm install -g pnpm

# ---------------------------------
# 阶段 5: 设置工作目录 (保持不变)
# ---------------------------------
WORKDIR /workspace

# ---------------------------------
# 阶段 6: 安装项目依赖 (利用缓存) (保持不变)
# ---------------------------------
COPY pnpm-lock.yaml* ./
COPY package.json ./
RUN pnpm install

# ---------------------------------
# 阶段 7: 复制项目源代码 (保持不变)
# ---------------------------------
COPY . .

# ---------------------------------
# 阶段 8: 暴露端口 (保持不变)
# ---------------------------------
EXPOSE 4321

